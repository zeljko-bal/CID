
{%- macro gui_structure(structure) %}
	{%- for element in structure.elements %}
		{{- gui_element(element)|tab_indent }}
	{%- endfor %}
{%- endmacro -%}

{%- macro gui_element(element) %}
{%- if element|element_type == 'GuiTabs' -%}
<div class="z-depth-1" style="padding:7px;">
	<ul id = "{{'tabs'|new_unique_id}}" class="tabs">
		{%- for tab in element.elements %}
		<li class="tab"><a{% if loop.index == 1%} class="active"{% endif %} href="#{{'tabs'|current_unique_id}}_{{loop.index}}">{{tab.title}}</a></li>
		{%- endfor %}
	</ul>
	{%- for tab in element.elements %}
	<div class="tab-body" id="{{'tabs'|current_unique_id}}_{{loop.index}}">
		{{- gui_structure(tab.body)|tab_indent }}
	</div>
	{%- endfor %}
</div>
{%- elif element|element_type == 'GuiSectionGroup' %}
<div style="padding:7px;">
	<ul class="collapsible{% if element.exclusive %} popout{% endif %}" data-collapsible="{% if element.exclusive %}accordion{% else %}expandable{% endif %}">
		{%- for section in element.elements %}
		<li>
			<div class="collapsible-header{% if element.exclusive %} exclusive-section{% endif %}{% if section.expanded %} active{% endif %}">
				<i class="material-icons section-check-icon">{% if not element.exclusive %}toc{% else %}{% if section.expanded %}check_circle{% else %}radio_button_unchecked{% endif %}{% endif %}</i>
				{{section.title}}
				<i class="material-icons right section-cariusel-icon grey-text text-lighten-2">short_text</i>
			</div>
			<div class="collapsible-body">
				{{- gui_structure(section.body)|tab_indent(3) }}
			</div>
		</li>
		{%- endfor %}
	</ul>
</div>
{%- elif element|element_type == 'GuiSection' %}
<div style="padding:7px;">
	<ul class="collapsible" data-collapsible="expandable">
		<li>
			<div class="collapsible-header{% if element.expanded %} active{% endif %}{% if element.optional %} optional-section{% endif %}">
				<i class="material-icons section-check-icon">{% if not element.optional %}toc{% else %}{% if element.expanded %}check_circle{% else %}radio_button_unchecked{% endif %}{% endif %}</i>
				{{element.title}}
				<i class="material-icons right section-expand-icon">expand_more</i>
			</div>
			<div class="collapsible-body">
				{{- gui_structure(element.body)|tab_indent(3) }}
			</div>
		</li>
	</ul>
</div>
{%- elif element|element_type == 'GuiGrid' -%}
<div style="padding:7px;">
	<table>
		{%- for row in element.elements %}
		{{ gui_grid_row(row)|tab_indent }}
		{%- endfor %}
	</table>
</div>
{%- elif element|element_type == 'Parameter' -%}
{{- gui_parameter(element) }}
{%- endif -%}
{%- endmacro -%}

{%- macro gui_grid_row(row) %}
<tr>
	{%- for cell in row.elements %}
		{%- set dim = row.dimensions[loop.index-1] %}
		<td{% if dim.colspan != 1 %} colspan="{{dim.colspan}}"{% endif %} style="min-width: {% if cell|element_type == 'Parameter' and cell.type == 'Bool' %}1{% else %}{{dim.width}}{% endif %}%;">
		{%- if cell|element_type == 'Parameter' %}
			{{- gui_parameter(cell, dim.colspan, dim.width)|tab_indent(2) }}
		{%- endif %}
		</td>
	{%- endfor %}
</tr>
{%- endmacro -%}

{%- macro param_title(element, i=None) -%}
{{element.title}}{% if element.nonpositional and i != None %} : {% if element.cli_pattern_vars %}{{element.cli_pattern_vars[i]}}{% else %}{{i+1}}{% endif %}{% endif %}
{%- endmacro -%}

{%- macro param_id(element, i=None) -%}
{{element.id}}{% if i != None %}:{{i}}{% endif %}
{%- endmacro -%}

{%- macro gui_parameter(element, colspan=1, width=0) %}
<div style="padding:15px;">
	<div style="display:flex; align-items:flex-start;">
{%- if element.type == 'Bool' %}
		<div style="flex-grow: 1;">
			<input type="checkbox" id="{{element.id|new_unique_id}}"{% if element.none_value_allowed %} class="tristate-checkbox"{% endif %}{% if element.default == None %} readonly{% elif element.default|lower == 'true' %} checked{% endif %}/>
			<label for="{{element.id|current_unique_id}}" style="white-space: nowrap;">{{element.title}}</label>
			{%- if element.default == None %}
			<script>document.getElementById("{{element.id|current_unique_id}}").indeterminate = true;</script>
			{%- endif %}
		</div>
{%- elif element.type in ['Str', 'Num', 'Date', 'File', 'Choice'] %}
	{%- if element.none_value_allowed %}
		<div style="width:40px;">
			<div class="none-switch switch" style="left:15px; top:45px;">
				<label>
					<input id="{{element.id}}_none_switch" type="checkbox"{% if element.default != None %} checked{% endif %}/>
					<span class="lever"></span>
				</label>
			</div>
		</div>
	{%- endif %}
	
	{%- set count_many = True if element.nonpositional and element.cli_pattern_count != 1 else False %}
	
	{%- if not count_many and not element.multiplicity == '*' %}
		<div style="flex-grow: 1;">
			{{- multi_parameter_body(element)|tab_indent(3) }}
		</div>
	{%- elif (count_many and not element.multiplicity == '*') or (not count_many and element.multiplicity == '*') %}
		<ul style="display:flex; flex-direction:column; flex-grow: 1;">
			{%- set count = 1 if element.multiplicity == '*' or element.cli_pattern_count == '*' else element.cli_pattern_count %}
			{%- for i in range(0, count) %}
			<li>
				{{- multi_parameter_body(element, i)|tab_indent(4) }}
			</li>
			{%- endfor %}
		</ul>
	{%- else %}
		<ul class="collection" style="display:flex; flex-direction:column; flex-grow: 1;">
			<li class="collection-item">
				<span>{{element.title}}</span>
				<a href="#!" class="secondary-content"><i class="material-icons">playlist_add</i></a>
			</li>
			<li class="collection-item" style="border-style:none solid solid solid; border-width:1px; border-color:grey grey grey #bababa; position:relative;">
				<ul style="display:flex; flex-direction:column;">
					{%- set count = 1 if element.cli_pattern_count == '*' else element.cli_pattern_count %}
					{%- for i in range(0, count) %}
					<li>
						{{- multi_parameter_body(element, i)|tab_indent(4) }}
					</li>
					{%- endfor %}
				</ul>
				<a href="#!"><i class="material-icons teal-text text-lighten-2" style="position:absolute; top:3px; right:3px;">delete_sweep</i></a>
			</li>
		</ul>
	{%- endif %}
{%- endif %}
	</div>
</div>
{%- endmacro -%}

{%- macro multi_parameter_body(element, i=None) -%}
{%- set list_item = True if i != None else False %}
<div class="input-field{% if element.type == 'Num' %} number-input-wrapper{% elif element.type == 'File' %} file-field{% endif %}"> <!--TODO number-input-wrapper i flex-grow: 1; -->
{%- if element.type in ['Str', 'Num', 'Date'] %}
	<input id="{{param_id(element, i)}}" type="{% if element.type == 'Str' %}text{% elif element.type == 'Num' %}number{% elif element.type == 'Date' %}date{% endif %}"{% if element.type == 'Date' %} class="datepicker"{% endif %}{% if element.default %} value="{% if list_item %}{{element.default[i]}}{% else %}{{element.default}}{% endif %}"{% elif element.default == None %} disabled{% endif %}/>
	<label for="{{param_id(element, i)}}">{{param_title(element, i)}}</label>
{%- elif element.type == 'File' %}
	<div class="btn" style="padding-left:15px; padding-right:15px; text-transform:none;">
		<i class="material-icons left">insert_drive_file</i> <!-- folder ili file ikona po ogranicenju -->
	<span>{{param_title(element, i)}}</span>
		<input type="file"/> <!--webkitdirectory dodati za ogranicenje directory-->
	</div>
	<div class="file-path-wrapper">
		<input id="{{param_id(element, i)}}" class="file-path validate" type="text"{% if element.default == None %} disabled{% endif %}/>
	</div>
{%- elif element.type == 'Choice' %}
	<div style="padding-bottom:1px;">
		<select id="{{param_id(element, i)}}">
			<option value="" selected style="border-style: solid; border-width:2px;border-color:black;"></option>
			{%- for choice in element.choices %}
			<option value="{{choice}}">{{choice}}</option>
			{%- endfor %}
		</select>
		<label>{{param_title(element, i)}}</label>
	</div>
{%- endif %}
	{%- set count_n = True if element.nonpositional and element.cli_pattern_count not in ['*', 1] else False %}
	{%- if list_item and not count_n %}<a href="#!" class="add-input-field" style="position:absolute; bottom:-10px; right:0px;"><i class="material-icons">add_box</i></a>{% endif %}
</div>
{%- endmacro -%}

<!DOCTYPE html>
<!-- Automatically generated code. Do not edit directly. -->
<html>
    <head>
		<!--Import Google Icon Font-->
		<link rel="stylesheet" href="materialize/css/material-icons.css">
		<!--Import materialize.css-->
		<link type="text/css" rel="stylesheet" href="materialize/css/materialize.css"  media="screen,projection"/>
		<!--Import custom.css-->
		<link type="text/css" rel="stylesheet" href="custom/css/custom.css"  media="screen,projection"/>
	</head>
    <body>
		<style>
			.select-wrapper .dropdown-content li:first-child
			{
				border-bottom-style: dashed;
				border-bottom-width: 1px;
				border-color: #cccccc;
			}
			
			nav
			{
				background-color: #bdbdbd;
				line-height: 36px;
				height: 36px;
				padding-left: 15px;
				margin-bottom: 35px;
			}
			
			tr.has-textarea td
			{
				vertical-align: top;
			}
			.collapsible-body, .tab-body
			{
				//padding-top: 25px;
			}
			.switch label .lever
			{
				margin: 0px;
			}
			
			input[type=number]::-webkit-inner-spin-button
			{ 
				height:40px;
			}
			
			.number-input-wrapper
			{
				max-width:15em;
			}
			
			.sub-command-wrapper
			{
				white-space: nowrap;
				margin-top: 5px;
				vertical-align: top;
			}
			.sub-command-wrapper button
			{
				padding-left:15px;
				padding-right:10px;
			}
			.sub-command-wrapper button span
			{
				vertical-align: top;
				margin-right:5px;
			}
			.sub-command-wrapper button i
			{
				font-size: 1.5rem;
			}
			
			div.switch.none-switch
			{
				width:1px;
				transform: rotate(-90deg) scale(0.85, 0.85);
				position:relative;
				right:5px;
				top:45px;
			}
			div.switch.none-switch input
			{
				display:none;
			}
			
			.command-panel td
			{
				padding-top: 10px;
				padding-bottom: 10px;
			}
			
		</style>
		<div class="container">
			<h4>{{root_command_name}}</h4>
			{%- for command in commands %}
				{%- if command.parameters or command.sub_commands %}
			<div id="{{command.id}}" class="command-panel"{% if command.id != root_command_id %} style="display:none;"{% endif %}>
				{%- if command.id != root_command_id %}
				<nav>
					{%- for parent_command in command|all_parent_commands %}
					<a data-command-id="{{parent_command.id}}" href="#!" class="parent-command-link breadcrumb">{{parent_command.title}}</a>
					{%- endfor %}
					<a href="#!" class="breadcrumb">{{command.title}}</a>
				</nav>
				{%- else %}
				<hr/>
				{%- endif %}
				{%- if command.description %}
				<div class="command-description">
					<p>{{command.description}}</p>
				</div>
				{%- endif -%}
				{{- gui_structure(command.gui)|tab_indent(4) }}
				<hr/>
				<table class="bordered">
					{%- for sub_command in command.sub_commands %}
					<tr>
						<td class="sub-command-wrapper">
							<button  data-command-id="{{sub_command.id}}" type="button" class="btn{% if sub_command.parameters or sub_command.sub_commands %} sub-command-button{% endif %}"><span>{{sub_command.title}}</span><i class="material-icons">{% if sub_command.parameters or sub_command.sub_commands %}navigate_next{% else %}play_arrow{% endif %}</i></button>
						</td>
						<td style="width: 15px;"/>
						<td>
							{{sub_command.description}} asdasd sdfsd asd
						</td>
					</tr>
					{%- endfor %}
				</table>
			</div>
				{%- endif %}
			{%- endfor %}
		</div>
		<br/><br/><br/><br/><br/><br/><br/><br/><br/>
		
		<!-- Script imports -->
		<!-- script-import hack for electron, http://stackoverflow.com/questions/32621988/electron-jquery-is-not-defined -->
		<script>if (typeof module === 'object') {window.module = module; module = undefined;}</script>
		
		<!--Import jQuery before materialize.js-->
		<!-- jQuery -->
		<script type="text/javascript" src="materialize/js/jquery-2.1.1.min.js"></script>
		<!-- Include all compiled bootstrap plugins -->
		<script type="text/javascript" src="materialize/js/materialize.min.js"></script>
		
		<!-- Import custom.js -->
		<script type="text/javascript" src="custom/js/custom.js"></script>
		
		<!-- script-import hack for electron -->
		<script>if (window.module) module = window.module;</script>
	</body>
	
	<script>
		// You can also require other files to run in this process
		require('./renderer.js');
		
		// ------------------- MATERIALIZE INIT -------------------
		
		$('.datepicker').pickadate({
			selectMonths: true, // Creates a dropdown to control month
			selectYears: 15 // Creates a dropdown of 15 years to control year
		});
		
		$('select').material_select();
		
		// ------------------- SECTION ICONS -------------------
		
		var activated_icon = 'check_circle';
		var deactivated_icon = 'radio_button_unchecked';
		
		$('.collapsible-header.exclusive-section').click(function(event)
		{
			var current_section = $(this);
			var section_group = current_section.parent().parent();
			
			var sections = section_group.children('li').children('div.collapsible-header');
			
			for(var i=0; i<sections.length; i++)
			{
				other_section = $(sections[i]);
				
				if(!other_section.is(current_section))
				{
					other_section.children('i.section-check-icon').text(deactivated_icon);
				}
			}
			
			if(current_section.hasClass('active'))
			{
				event.stopPropagation();
			}
			else
			{
				current_section.children('i.section-check-icon').text(activated_icon);
			}
		});
		
		$('.collapsible-header.optional-section').click(function()
		{
			var current_section = $(this);
			if(current_section.hasClass('active'))
			{
				current_section.children('i.section-check-icon').text(deactivated_icon);
				current_section.children('i.section-expand-icon').text('expand_more');
			}
			else
			{
				current_section.children('i.section-check-icon').text(activated_icon);
				current_section.children('i.section-expand-icon').text('expand_less');
			}
		});
		
		// ------------------- COMMAND PANELS -------------------
		
		function toggle_command_panel()
		{
			var button = $(this);
			var command_id = button.attr('data-command-id');
			
			var command_panels = $(".command-panel");
			
			for(var i=0; i<command_panels.length; i++)
			{
				command_panel = $(command_panels[i]);
				
				if(command_panel.attr('id') == command_id)
				{
					command_panel.fadeIn(200);
				}
				else
				{
					command_panel.hide();
				}
			}
		}
		
		$('.sub-command-button').click(toggle_command_panel);
		$('.parent-command-link').click(toggle_command_panel);
		
		// ------------------- TRISTATE CHECKBOX -------------------
		
		$(".tristate-checkbox").click(function() // add tri-state checkbox functionality
		{
			if (this.readOnly) this.checked=this.readOnly=false;
			else if (!this.checked) this.readOnly=this.indeterminate=true;
		});
		
		function get_checkbox_state(cb) // get checkbox state: true, false or null (intermidiate)
		{
			if(cb.indeterminate) return null;
			else return cb.checked;
		}
		
		// ------------------- NONE SWITCH -------------------
		
		$('.none-switch input').click(function(event)
		{
			var none_switch = $(event.delegateTarget);
			var switch_id = none_switch.attr('id');
			var param_id = switch_id.substring(0, switch_id.length - '_none_switch'.length);
			
			$('[id='+param_id+']').prop('disabled', !none_switch.prop('checked'));
		});
		
		// -------------------
		
		
		
		$('.add-input-field').click(function()
		{
			var input_field = $(this);
			
			
			
			
		});
		
	</script>
</html>